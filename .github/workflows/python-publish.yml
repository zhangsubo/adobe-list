name: å®šæ—¶æ›´æ–°åŸŸååˆ—è¡¨

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 10:00 (UTC 02:00)
    - cron: '0 2 * * *'
    # åŒ—äº¬æ—¶é—´ 17:00 (UTC 09:00)
    - cron: '0 9 * * *'
    # åŒ—äº¬æ—¶é—´ 22:00 (UTC 14:00)
    - cron: '0 14 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶ä¹Ÿè§¦å‘ï¼ˆå¯é€‰ï¼‰
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - '.github/workflows/*.yml'

jobs:
  update-list:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. è¿è¡Œè„šæœ¬ï¼ˆæ— éœ€å®‰è£…ä¾èµ–ï¼‰
      - name: è¿è¡Œ main.py
        run: |
          echo "å¼€å§‹æ‰§è¡Œ main.py..."
          python main.py
          echo "æ‰§è¡Œå®Œæˆ"
      
      # 4. æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          if [ -f list.list ]; then
            echo "âœ… list.list æ–‡ä»¶å·²ç”Ÿæˆ"
            echo "åŸŸåæ•°é‡: $(wc -l < list.list)"
            echo ""
            echo "å‰10è¡Œé¢„è§ˆ:"
            head -10 list.list
          elif [ -f host/list.list ]; then
            echo "âœ… host/list.list æ–‡ä»¶å·²ç”Ÿæˆ"
            echo "åŸŸåæ•°é‡: $(wc -l < host/list.list)"
            echo ""
            echo "å‰10è¡Œé¢„è§ˆ:"
            head -10 host/list.list
          else
            echo "âš ï¸ æœªæ‰¾åˆ°è¾“å‡ºæ–‡ä»¶"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
          fi
      
      # 5. æäº¤æ›´æ”¹
      - name: æäº¤æ›´æ–°çš„æ–‡ä»¶
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œæ— éœ€æäº¤"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤..."
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°åŸŸååˆ—è¡¨ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… æ›´æ”¹å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“"
          fi
      
      # 6. æ˜¾ç¤ºæ‰§è¡Œæ‘˜è¦
      - name: æ˜¾ç¤ºæ‰§è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "================================"
          echo "æ‰§è¡Œæ—¶é—´ (UTC): $(date +'%Y-%m-%d %H:%M:%S')"
          echo "æ‰§è¡Œæ—¶é—´ (åŒ—äº¬): $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "Python ç‰ˆæœ¬: $(python --version)"
          echo "================================"
